---
title: "A data-driven planning framework for curbside loading zones - exploratory data analysis"
author: " "
date: 2024-01-30
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE)
```

## 1 Introduction

Sam

## 2 Data Manipulation and Visualization

```{r , include=FALSE}

# You can set some global options for knitting chunks

knitr::opts_chunk$set(echo = TRUE)

# Load some libraries

library(tidyverse)
library(tidycensus)
library(sf)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(grid)
library(gridExtra)
library(ggcorrplot) # plot correlation plot
library(corrr)      # another way to plot correlation plot
library(kableExtra)
library(broom)
library(tufte)
library(rmarkdown)
library(hexbin)
library(viridis)
library(cbsodataR)
library(jtools)     # for regression model plots
library(ggstance) # to support jtools plots
library(ggpubr)    # plotting R^2 value on ggplot point scatter
library(broom.mixed) # needed for effects plots
library(stargazer)
library(jsonlite)
library(ggplot2)
library(tmap)
library(tmaptools)
library(leaflet)
library(raster)
library(RColorBrewer)
library(mapview)
library(leaflet)
library(plotly)
library(ggspatial)
library(openxlsx)


#library(rjson)

# functions and data directory

#source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

palette4 <- c("#005B96", "#FFD700", "#E63946", "#F0F0F0")
palette5 <- c("#005B96", "#FFD700", "#E63946", "#2A9D8F", "purple")
palette6 <- c("#005B96", "#FFD700", "#E63946", "#2A9D8F", "#264653", "#F0F0F0")
palette7 <- c("#005B96", "#FFD700", "#E63946", "#2A9D8F", "#264653", "#E76F51", "#F0F0F0")
palette8 <- c("#005B96", "#FFD700", "#E63946", "#2A9D8F", "#264653", "#E76F51", "#F4A261", "#F0F0F0")

```

```{r setting working directory}
#Shengqian
#setwd("/Users/sqwang/Library/CloudStorage/OneDrive-PennO365/penn/6th/Practicum/Data")

#Sam
#setwd("")

#michael
#setwd("")

#tiffany
#setwd("")

#ling
setwd("/Users/lingchen/Documents/Practicum/Practicum_Philly_2024/Data")


coords_raw <- read.csv("./Old_Data_for_Testing/zoneCoords.csv")
# split coords
coords_split <- strsplit(coords_raw$coords, ",")
coords_raw$latitude <- as.numeric(sapply(coords_split, `[`, 1))
coords_raw$longitude <- as.numeric(sapply(coords_split, `[`, 2))
# create coords shapefile
coords <- st_as_sf(coords_raw, coords = c("longitude", "latitude"), crs = 'ESRI:102729')


linAssets <- read_sf('./resmartloadingzones/Curb_and_Asset_Shapefiles/linear_assets.shp')%>% st_transform('ESRI:102729')
# load booking data
booking_data <-st_read("./Old_Data_for_Testing/Booking Data_times.geojson")

# load curb zone data
curb_zone <-  read_json("./resmartloadingzones/curb_zones.json")

# load CDS event data
event_export <- read.csv("./events_export_CDS.csv")

# load regulation geojson
regulations <- st_read("./resmartloadingzones/regulations.geojson")

# load pilot data
pre_pilot <- read.xlsx("./PHL_Pre-Pilot NN Collection Data_2022_12.xlsx")
mid_pilot <- read.xlsx("./PHL_Mid-Pilot NN Collection_2023_02.xlsx")

```

## Utilization of curb zones

```{r}
utilization <- booking_data %>%
  dplyr::select(OMFCurbZoneID,EventType,ViolationType,VehicleType,TimeRequestedHour,Amount,geometry)
```

```{r timesegment}
utilization$DwellTimeMinutes <- utilization$TimeRequestedHour * 60

utilization$TimeSegment <- cut(utilization$DwellTimeMinutes,
                        breaks = c(0, 5, 15, 30, 45, 61),
                        labels = c("0-5", "6-15", "16-30", "31-45","46-60"),
                        right = FALSE)

utilization <- utilization %>%
  mutate(TimeSegment = as.character(TimeSegment), # Convert factor to character
         TimeSegment = replace_na(TimeSegment, "violation")) # Replace NA with "violation"

utilization$TimeSegment <- factor(utilization$TimeSegment)

utilization <- utilization %>%
  mutate(ViolationType = ifelse(ViolationType == "", "booking", ViolationType)) 

```

## Exploratory Analysis

```{r}
# dwell time - min
ggplot(utilization, aes(x = DwellTimeMinutes)) + geom_histogram(bins = 50, fill = "blue", color = "black") +
  labs(title = "Dwell Time Distribution", x = "Dwell Time (minutes)", y = "Frequency")

ggplot(utilization, aes(x = TimeSegment)) +
  geom_bar(fill = "steelblue", color = "black") + 
  theme_minimal() + 
  labs(title = "Counts by Time Segment", x = "Time Segment", y = "Count") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# vehicle type:commercial/medium commercial/other/truck
ggplot(utilization, aes(x = VehicleType)) + geom_bar(fill = "green") +
  labs(title = "Vehicle Type Distribution", x = "Vehicle Type", y = "Count")

# vehicle type: car/freight/truck/van
ggplot(utilization, aes(x = EventType)) + geom_bar(fill = "orange") +
  labs(title = "Event Type Distribution", x = "Event Type", y = "Count")

```

```{r}
# Availability of curb zones
# vehicle count by curb zone and tiem segment
availability_analysis <- utilization %>%
  group_by(OMFCurbZoneID, TimeSegment) %>%
  summarise(VehicleCount = n())

ggplot(availability_analysis, aes(x = OMFCurbZoneID, y = VehicleCount, fill = TimeSegment)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "Vehicle Count by Curb Zone and Time Segment", x = "Curb Zone ID", y = "Vehicle Count")

# violation type distribution by curb zone
violation_analysis <- utilization %>%
  group_by(OMFCurbZoneID, ViolationType) %>%
  summarise(Count = n())

ggplot(violation_analysis, aes(x = OMFCurbZoneID, y = Count, fill = ViolationType)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "Violation Type Distribution by Curb Zone", x = "Curb Zone ID", y = "Count")

```

```{r}
utilization_sf <- st_as_sf(utilization, wkt = "geometry", crs = 4326)

# distribution of Curb Zones
ggplot() +
  annotation_map_tile(zoom = 12) +  # Adjust the zoom level as needed
  geom_sf(data = utilization_sf, aes(color = TimeSegment), size = 0.7) +
  labs(title = "Spatial Distribution of Curb Zones in Philadelphia", x = "Longitude", y = "Latitude") +
  theme_minimal()

```

```{r}
leaflet(utilization_sf) %>%
  addTiles() %>%  # Add default OpenStreetMap tiles
  addProviderTiles(providers$Stamen.TonerLite, options = providerTileOptions(noWrap = TRUE)) %>% # Add a base map layer
  addCircles(lng = ~st_coordinates(geometry)[, 1], lat = ~st_coordinates(geometry)[, 2], 
             color = ~colorFactor(palette = "Dark2", domain = utilization_sf$DwellTimeMinutes)(DwellTimeMinutes), 
             popup = ~paste("Dwell Time Minutes:", DwellTimeMinutes),
             radius = 20) %>% # Add circles for each point
  addLegend("bottomright", pal = colorFactor(palette = "Dark2", domain = utilization_sf$DwellTimeMinutes), 
            values = ~DwellTimeMinutes, title = "Dwell Time Minutes", opacity = 1) %>% # Add a legend
  setView(lng = -75.16407, lat = 39.94951, zoom = 13) # Center the map around Philadelphia


```

### OpenStreetMap exploration

The "**amenity**" types we collected were: "bar", "cafe", "fast_food", "pub", "restaurant", "college", "school", "university", "parking_space", "bank", "atm", "clinic", "hospital", "pharmacy", "community_centre", "conference_centre", "nightclub", "theatre", "police", "post_box", "post_office", "place_of_worship"

The "**building**" types we collected were: "apartments", "dormitory", "hotel", "commercial", "office", "retail", "supermarket", "warehouse", "church", "college", "government", "hospital", "public", "school", "university"

The "**shop**" types we collected were: "alcohol", "bakery", "beverages", "coffee", "convenience", "deli", "department_store", "general", "supermarket", "clothes", "gift"

We also collected **office** building types and **land uses** but these data were not a large enough sample.

```{r openstreemap location collection, message=FALSE}
# amenities <- c("bar", "cafe", "fast_food", "pub", "restaurant", "college", "school", "university", 
#                    "parking_space", "bank", "atm", "clinic", "hospital", "pharmacy", "community_centre", 
#                    "conference_centre", "nightclub", "theatre", "police", "post_box", "post_office", 
#                    "place_of_worship")
# 
# # Format the list: remove underscores, capitalize first letter, and put in quotes
# formatted_list <- gsub("_", " ", amenities)
# formatted_list <- gsub("^([a-z])", "\\U\\1", formatted_list, perl = TRUE)
# formatted_list_1 <- paste0('"', formatted_list, '"')
# 
# buildings <- c("apartments", "dormitory", "hotel", "commercial", "office", 
#                    "retail", "supermarket", "warehouse", "church", "college", 
#                    "government", "hospital", "public", "school", "university")
# 
# formatted_list <- gsub("_", " ", buildings)
# formatted_list <- gsub("^([a-z])", "\\U\\1", formatted_list, perl = TRUE)
# formatted_list_2 <- paste0('"', formatted_list, '"')
# 
# shops <- c("alcohol", "bakery", "beverages", "coffee", "convenience", "deli",
#                    "department_store", "general", "supermarket", "clothes", "gift")
# 
# formatted_list <- gsub("_", " ", shops)
# formatted_list <- gsub("^([a-z])", "\\U\\1", formatted_list, perl = TRUE)
# formatted_list_3 <- paste0('"', formatted_list, '"')
# 
# # Create a dataframe
# poi_types <- data.frame(Amenities = formatted_list_1, Buildings = formatted_list_2, Shops = formatted_list_3)
```

Assuming that distance to some certain types of buildings relates to how much cars and trucks need to use loading zones there, we calculated the distance from each pilot loading zone to the three nearest of each of these types.

```{r nearest neighbors, message=FALSE}
test <- st_read("C:/Users/14145/Box/Practicum_Philly_2024/Michael/zones_nn_3.geojson")

numeric <- test %>%
  dplyr::select(-c("SmartZoneName")) %>%
  st_drop_geometry(.) %>%
  mutate(log10events = log10(events))

#Correlation plot
corplot <- cor(numeric)

cor_df <- as.data.frame(corplot)

# Extract the column values and row names
column_name <- "log10events"  # Replace "mpg" with the column name you want to plot
column_values <- cor_df[[column_name]]
cor_df <- data.frame(variable = rownames(cor_df), correlation = column_values)

cor_df <- filter(cor_df, variable != "events" & variable != "log10events")

# Create a bar plot using ggplot2
ggplot(cor_df, aes(x = reorder(variable, -correlation), y = correlation, fill=correlation)) +
  geom_bar(stat = "identity") +
  labs(title = "Relationships with Log10 Events",
       x = "Nearest Neighbor Variables",
       y = "Correlation") +
  ylim(-1,1)+
  scale_fill_viridis_c()+
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
ggplotly(p=ggplot2::last_plot())
```

```{r clear NN table}
filter(cor_df, abs(correlation) > 0.5) %>%
  ggplot(., aes(x = reorder(variable, -correlation), y = correlation, fill=correlation)) +
  geom_bar(stat = "identity") +
  labs(title = "Strongest Relationships (>0.5) with Log10 Events",
       x = "Nearest Neighbor Variables",
       y = "Correlation") +
  ylim(-1,1)+
  scale_fill_viridis_c()+
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
```

Many of the strongest relationships are negative ones. In particular, decreasing correlation with the number of parking events at a loading zone come with distance from a place of worship.

The positive relationships are associated with clinics and community centers.
